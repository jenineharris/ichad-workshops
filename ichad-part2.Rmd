---
title: "Introduction to R"
subtitle: "Tables and Figures in R"
output: html_document
---

## How to follow along and participate

```{r chunk1}
library(package = "here")
library(package = "tidyverse")
library(package = "haven")
library(package = "table1")
```


## Importing data into R


```{r chunk2}
# use here so that R looks in the same folder you are in
here()

# use read_spss function to read the spss file 
globalData2019 <- read_spss(file = "Pew Research Center Global Attitudes Spring 2019 Dataset WEB.sav")
```

## Data cleaning (revise from prior workshop)

```{r chunk3}
globalData2019clean <- globalData2019 %>%
  filter(country %in% c(16, 21, 26, 34)) %>% 
  select(country, SEX, AGE, BETTER_GENDER, COUNTRY_SATIS, 
         ECON_SIT, LADDER_NOW) %>% 
  zap_labels() %>%
  mutate(AGE = na_if(AGE, 98)) %>% 
  mutate(AGE = na_if(AGE, 99)) %>% 
  mutate(LADDER_NOW = na_if(LADDER_NOW, 98)) %>% 
  mutate(LADDER_NOW = na_if(LADDER_NOW, 99)) %>% 
  mutate(country = recode_factor(country,
                             '16' = 'Kenya',
                             '21' = 'Nigeria',
                             '26' = 'South Africa',
                             '34' = 'United States')) %>%
  mutate(SEX = recode_factor(SEX,
                             '1' = 'Male',
                             '2' = 'Female')) %>% 
  mutate(BETTER_GENDER = recode_factor(BETTER_GENDER,
                                    '1' = 'Men',
                                    '2' = 'Women',
                                    '3' = 'Same/both equally',
                                    '8' = NA_character_,
                                    '9' = NA_character_)) %>% 
  mutate(COUNTRY_SATIS = recode_factor(COUNTRY_SATIS,
                                       '1' = 'Satisfied',
                                       '2' = 'Dissatisfied',
                                       '8' = NA_character_,
                                       '9' = NA_character_)) %>% 
  mutate(ECON_SIT = recode_factor(ECON_SIT,
                                  '1' = 'Very good',
                                  '2' = 'Somewhat good',
                                  '3' = 'Somewhat bad',
                                  '4' = 'Very bad',
                                  '8' = NA_character_,
                                  '9' = NA_character_)) 
```


## Check your work

```{r chunk4}
summary(object = globalData2019clean)
```


## Basic table with labels

```{r chunk5}
label(globalData2019clean$SEX) <- "Sex"
label(globalData2019clean$AGE) <- "Age (years)" 
label(globalData2019clean$BETTER_GENDER) <- "Who has a better life in this country"
label(globalData2019clean$COUNTRY_SATIS) <- "Satisfied or dissatisfied with the way things are going in (country)"
label(globalData2019clean$ECON_SIT) <- "How would you describe the current economic situation (country)" 
label(globalData2019clean$LADDER_NOW) <- "Where are you between worst possible life (0) to best possible life (10)"
```


## Table with labels

```{r chunk6}
table1(~ AGE + LADDER_NOW + BETTER_GENDER + COUNTRY_SATIS + ECON_SIT | SEX,
       data = globalData2019clean, overall = FALSE)
```


## Customize the table: Choosing stats to display

* Typically continuous variables would use mean and standard deviation -or- median and interquartile range (IQR), but not both 

* Use the `render.continuous` argument to change what is displayed for continuous variables

* Options include N, NMISS, MEAN, SD, CV, GMEAN, GCV, MEDIAN, MIN, MAX, IQR, Q1, Q2, Q3, T1, T2, FREQ, PCT (see help documentation for `stats.default` for definitions)


## Customized table with mean and standard deviation

```{r chunk7}
table1(~ AGE + LADDER_NOW + BETTER_GENDER + COUNTRY_SATIS + ECON_SIT | SEX,
       data = globalData2019clean, overall = FALSE,
       render.continuous = c(. = "Mean (SD)"))
```


## Customize the table: Change table appearance

* There are several options for appearance that can be changed using the `topclass` argument with the `table1()` function

    + zebra: alternating shaded and unshaded rows (zebra stripes) 
    
    + grid: show all grid lines 
    
    + shade: shade the header rows in gray
    
    + times: use a serif font
    
    + center: center all columns, including the row labels column 
    
* Argument must start with `Rtable1-`

   + For multiple arguments, separate with a space
    

## Customize the table: Change table appearance example

```{r chunk8}
table1(~ AGE + LADDER_NOW + BETTER_GENDER + COUNTRY_SATIS + ECON_SIT | SEX,
       data = globalData2019clean, overall = FALSE,
       render.continuous = c(. = "Mean (SD)"), 
       topclass = "Rtable1-times Rtable1-grid Rtable1-shade")
```


## Customize the table: Use multiple variables to stratify

```{r chunk9}
table1(~ AGE + LADDER_NOW + BETTER_GENDER + COUNTRY_SATIS + ECON_SIT | country*SEX,
       data = globalData2019clean, overall = FALSE,
       render.continuous = c(. = "Mean (SD)"), 
       topclass = "Rtable1-times Rtable1-grid")
```


## BREAK

* Something to try on your break 

    + Copy the table code from the previous code chunk 
    
    + After the final quotation mark inside the parentheses add a comma and hit enter
    
    + On the new line, type `footnote = "This is a footnote to the table."`
    
    + Change the order of `country*SEX` to be `SEX*country`
    
    + Run the code and see what happens 
    
    + Edit the footnote as you see fit 
    
    + Play with other formatting and content of the table 


## Basic bar chart

```{r chunk10}
globalData2019clean %>%
  ggplot(aes(x = SEX)) +
  geom_bar() 
```

## Fancy bar chart

```{r chunk11}
globalData2019clean %>%
  ggplot(aes(x = SEX)) +
  geom_bar(fill = "deeppink") +
  labs(x = "Sex",
       y = "Frequency",
       title = "Sex of 5001 participants in a 2019 survey of people from Kenya,\nNigeria, South Africa, and the United States.") +
  theme_minimal()
```

## Fancy bar chart with colors

```{r chunk12}
globalData2019clean %>%
  ggplot(aes(x = SEX, fill = SEX)) +
  geom_bar() +
  labs(x = "Sex",
       y = "Frequency",
       title = "Sex of 5001 participants in a 2019 survey of people from Kenya,\nNigeria, South Africa, and the United States.") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()
```

## Fancy bar chart without legend

```{r chunk13}
globalData2019clean %>%
  ggplot(aes(x = SEX, fill = SEX)) +
  geom_bar() +
  labs(x = "Sex",
       y = "Frequency",
       title = "Sex of 5001 participants in a 2019 survey of people from Kenya,\nNigeria, South Africa, and the United States.") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "none") 
```

## You try it!

Make a bar chart of the `BETTER_GENDER` responses from survey participants with the Figure 1 code in your R Markdown file ().

Edit the code to: 

* Use `BETTER_GENDER` as the fill variable in the `ggplot()` layer

* Change the color of the bars by replacing "Set2" with the name of another palette found on the <a href = "https://www.datanovia.com/en/blog/the-a-z-of-rcolorbrewer-palette/">https://www.datanovia.com/en/blog/the-a-z-of-rcolorbrewer-palette/</a> website

* Add labels for the axes and a title inside the quote marks (see codebook for more about the question)

* Replace `theme_minimal()` with another theme, you can find them here: https://ggplot2.tidyverse.org/reference/ggtheme.html

When you have completed the changes, click the little green arrow on the top right of the code chunk to run the code.

```{r}

```


## Stacked bar plot

```{r chunk14}
globalData2019clean %>% 
  drop_na(BETTER_GENDER) %>% 
  ggplot(aes(x = BETTER_GENDER, fill = SEX)) +
  geom_bar() +
  labs(x = "Who has better life",
       y = "Frequency",
       title = "Who has a better life by sex according to 5001 participants\nin a 2019 survey of people from Kenya, Nigeria, South Africa,\nand the United States.") +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() 
```

## Grouped bar plot

```{r chunk15}

globalData2019clean %>% 
  drop_na(BETTER_GENDER) %>% 
  ggplot(aes(x = BETTER_GENDER, fill = SEX)) +
  geom_bar(position = "dodge") +
  labs(x = "Who has better life",
       y = "Frequency",
       title = "Who has a better life by sex according to 5001 participants\nin a 2019 survey of people from Kenya, Nigeria, South Africa,\nand the United States.",
       fill = "Survey participant sex") +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() 
```


## You try it!

* Create a grouped bar plot for Figure 2 with `COUNTRY_SATIS` as the x-axis and `SEX` as the fill color 

* Drop the `NA` values for `COUNTRY_SATIS`

* Add good labels for the x-axis, y-axis, title (may need the codebook for this)

* Format it using a palette you like  

* Fix the legend title so it is "Participant sex"

```{r chunk16}
# Figure 2 code goes here

```


## Answer to You try it!

```{r chunk17}
# Figure 2 code goes here
globalData2019clean %>% 
  drop_na(COUNTRY_SATIS) %>% 
  ggplot(aes(x = COUNTRY_SATIS, fill = SEX)) +
  geom_bar(position = "dodge") +
  labs(x = "Satisfied or dissatisfied with the way things\nare going in our country ",
       y = "Frequency",
       title = "Country satisfaction by sex according to 5001 participants\nin a 2019 survey of people from Kenya, Nigeria, South Africa,\nand the United States.", 
       fill = "Participant sex") +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() 

```

## Group percentages

```{r chunk19}
globalData2019clean %>% 
  group_by(COUNTRY_SATIS, SEX) %>% 
  count() %>% 
  group_by(COUNTRY_SATIS) %>% 
  mutate(perc = 100 * (n / sum(n))) 
```

## Grouped bar plot

```{r chunk20}

globalData2019clean %>% 
  group_by(COUNTRY_SATIS, SEX) %>% 
  count() %>% 
  group_by(COUNTRY_SATIS) %>% 
  mutate(perc = 100 * (n / sum(n))) %>% 
  drop_na(COUNTRY_SATIS) %>% 
  ggplot(aes(x = COUNTRY_SATIS, y = perc, fill = SEX)) +
  geom_col(position = "dodge") +
  labs(x = "Satisfied or dissatisfied with the way things\nare going in our country ",
       y = "Percentage within satisfaction group",
       title = "Country satisfaction by sex according to 5001 participants\nin a 2019 survey of people from Kenya, Nigeria, South Africa,\nand the United States.", 
       fill = "Participant sex") +
  scale_fill_brewer(palette = "Paired") +
  theme_minimal() +
  scale_x_discrete(labels = 
                     function(x) 
                       str_wrap(x, width = 30))
```

## Histogram

```{r chunk21}
# Histogram for age
globalData2019clean %>% 
  ggplot(aes(x = AGE)) +
  geom_histogram() 
```

## Fancy histogram

```{r chunk22}
# Histogram for age
globalData2019clean %>% 
  ggplot(aes(x = AGE, fill = SEX)) +
  geom_histogram(color = "white") +
  labs(x = "Participant age (years)",
       y = "Frequency",
       title = "Age distribution by sex for 5001 participants in a 2019 survey\nof people from Kenya, Nigeria, South Africa, and the United States.") +
  scale_fill_brewer(palette = "Set1") +
  facet_grid(rows = vars(SEX)) +
  theme_minimal() +
  theme(legend.position = "none") 
```

## Box plot

```{r chunk23}

globalData2019clean %>% 
  ggplot(aes(x = SEX, y = AGE)) +
  geom_boxplot() +
  labs(x = "Participant sex",
       y = "Age",
       title = "Age by sex for 5001 participants in a 2019 survey of people\nfrom Kenya, Nigeria, South Africa, and the United States.") +
  theme_minimal() 
```

## Fancier box plot

```{r chunk24}

globalData2019clean %>% 
  ggplot(aes(x = SEX, y = AGE, color = SEX)) +
  geom_violin() +
  geom_boxplot() +
  geom_jitter() +
  labs(x = "Participant sex",
       y = "Age",
       title = "Age by sex for 5001 participants in a 2019 survey of people\nfrom Kenya, Nigeria, South Africa, and the United States.") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Fancier box plot

```{r chunk25}

globalData2019clean %>% 
  ggplot(aes(x = SEX, y = AGE, color = SEX)) +
  geom_violin() +
  geom_boxplot(width = .4) +
  geom_jitter(alpha = .3) +
  labs(x = "Participant sex",
       y = "Age",
       title = "Age by sex for 5001 participants in a 2019 survey of people from\nKenya, Nigeria, South Africa, and the United States.") +
  scale_color_brewer(palette = "Dark2") +
  theme_minimal() +
  coord_flip() +
  theme(legend.position = "none")
  
```

## Grouped box plot

```{r chunk26}

globalData2019clean %>% 
  ggplot(aes(y = LADDER_NOW, x = country, color = SEX)) +
  geom_boxplot() +
  labs(x = "Country",
       y = "Life ladder (0 = worst, 10 = best)",
       title = "Life ladder by sex and country for 5001 participants in a 2019 survey\nof people from Kenya, Nigeria, South Africa, and the United States.",
       color = "Sex") +
  theme_minimal() 
```



## The final challenges...choose one or try them all!

* Make a bar graph showing percentage of participants in each category of ECON_SIT 

* Create a figure that shows grouped bar plots for GLOBAL_COMMUNITY grouped by country

* Create a figure that shows grouped bar plots for country and COUNTRY_SATIS

* Create a figure that shows grouped bar plots for COUNTRY_SATIS grouped by country and SEX

* Create a figure that shows the distribution of AGE by country and SEX

```{r}

```

